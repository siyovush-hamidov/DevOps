---
- name: Install PostgreSQL and create database and user
  hosts: all
  become: yes

  vars:
    db_user: oscar
    db_pass: database
    db_name: database
    postgres_password: postgres

  tasks:
    - name: Install PostgreSQL on Debian-based systems
      apt:
        name: postgresql
        state: present
        update_cache: yes

    - name: Start and enable PostgreSQL service
      systemd:
        name: postgresql
        enabled: yes
        state: started

    - name: Ensure PostgreSQL is running
      service:
        name: postgresql
        state: started

    - name: Install psycopg2 for Ansible PostgreSQL modules
      apt:
        name: python3-psycopg2
        state: present

    - name: Get PostgreSQL version
      command: psql --version
      register: psql_version_output

    - name: Set PostgreSQL version fact
      set_fact:
        postgresql_version: "{{ psql_version_output.stdout.split(' ')[2].split('.')[0] }}"

    - name: Backup the original pg_hba.conf
      copy:
        src: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
        dest: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf.bak"
        remote_src: yes

    - name: Update pg_hba.conf to use trust authentication for local
      lineinfile:
        path: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
        regexp: '^local.*all.*all.*'
        line: 'local   all             all                                     trust'
        insertafter: '^# "local" is for Unix domain socket connections only'

    - name: Update pg_hba.conf to use trust authentication for IPv4
      lineinfile:
        path: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
        regexp: '^host.*all.*all.*127\.0\.0\.1/32.*'
        line: 'host    all             all             127.0.0.1/32            trust'
        insertafter: '^# IPv4 local connections:'

    - name: Update pg_hba.conf to use trust authentication for IPv6
      lineinfile:
        path: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
        regexp: '^host.*all.*all.*::1/128.*'
        line: 'host    all             all             ::1/128                 trust'
        insertafter: '^# IPv6 local connections:'

    - name: Add line to pg_hba.conf for samerole
      lineinfile:
        path: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
        line: 'host    samerole       all             0.0.0.0/0               trust'
        state: present
        insertafter: EOF

    - name: Update postgresql.conf to listen on all addresses
      replace:
        path: "/etc/postgresql/{{ postgresql_version }}/main/postgresql.conf"
        regexp: "^#listen_addresses = '\\*' # what IP address\\(es\\) to listen on;"
        replace: "listen_addresses = '*' \n# what IP address(es) to listen on;"

    - name: Restart PostgreSQL to apply changes
      systemd:
        name: postgresql
        state: restarted

    - name: Set password for postgres user
      postgresql_user:
        name: postgres
        password: "{{ postgres_password }}"
        role_attr_flags: "SUPERUSER"
        state: present
        login_user: postgres
        login_password: "{{ postgres_password }}"

    - name: Create PostgreSQL user
      postgresql_user:
        name: "{{ db_user }}"
        password: "{{ db_pass }}"
        state: present
        login_user: postgres
        login_password: "{{ postgres_password }}"

    - name: Create PostgreSQL database
      postgresql_db:
        name: "{{ db_name }}"
        owner: "{{ db_user }}"
        state: present
        login_user: postgres
        login_password: "{{ postgres_password }}"
